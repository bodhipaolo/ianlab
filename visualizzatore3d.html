<!-- visualizzatore3d.html -->
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visualizzatore 3D - Ian Lab</title>
    <style>
        body { margin: 0; font-family: sans-serif; }
        #viewer-container {
            width: 100vw;
            height: 100vh;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #model-viewer {
            width: 90%;
            height: 80%;
            background: #fff;
            border: 2px dashed #ccc;
        }
        #file-input {
            margin: 1rem;
        }
    </style>
</head>
<body>
    <div id="viewer-container">
        <input type="file" id="file-input" accept=".stl" />
        <div id="model-viewer"></div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
        import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';
        import { STLLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/STLLoader.js';

        const viewer = document.getElementById('model-viewer');
        const fileInput = document.getElementById('file-input');

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, viewer.clientWidth / viewer.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(viewer.clientWidth, viewer.clientHeight);
        viewer.innerHTML = '';
        viewer.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        camera.position.set(100, 100, 100);
        controls.update();

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(1, 1, 1).normalize();
        scene.add(dir);

        let mesh = null;

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(ev) {
                const contents = ev.target.result;
                const loader = new STLLoader();
                const geometry = loader.parse(contents);

                if (mesh) scene.remove(mesh);

                const material = new THREE.MeshPhongMaterial({ color: 0x606060, specular: 0x111111, shininess: 200 });
                mesh = new THREE.Mesh(geometry, material);
                geometry.computeBoundingBox();

                const center = new THREE.Vector3();
                geometry.boundingBox.getCenter(center);
                mesh.position.sub(center);

                scene.add(mesh);

                const size = geometry.boundingBox.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                camera.position.set(maxDim * 1.5, maxDim * 1.5, maxDim * 1.5);
                camera.lookAt(0, 0, 0);
                controls.update();
            };

            reader.readAsArrayBuffer(file);
        });
    </script>
</body>
</html>
